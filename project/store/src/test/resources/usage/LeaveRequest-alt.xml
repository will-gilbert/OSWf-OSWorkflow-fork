<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE workflow SYSTEM "OSWf-3.0.dtd">


<workflow>

    <!--  List of possible starting points in the workflow ===============================  -->
	<initial-actions>
		<action id="1" name="Start Workflow">
			<results>
				<default-result status="Underway" step="100"/>
			</results>
		</action>
	</initial-actions>


    <!-- Steps ============================================================================ -->
    
	<steps>
	
	    <!-- Employee submits leave request  =================================== -->
	    
		<step id="100" name="Employee request">
			<actions>
				<action id="101" name="request holidays">
					<results>
						<default-result split="10000" status="Leave Requested"/>
					</results>
				</action>
			</actions>
		</step>


	    <!-- Line Manager approves or denies request based on labor needs  ===== -->
	    
		<step id="200" name="Line Manager revision">
			<actions>
				<action id="201" name="approve" >
					<results>
						<default-result exit-status="Line approved" status="joining" join="10000" />
					</results>
				</action>
				<action id="202" name="deny" >
					<results>
						<default-result exit-status="Line denied" status="joining" join="10000"/>
					</results>
				</action>
			</actions>
		</step>

	    <!-- HR Manager approves or denies request based on employee record ==== -->

		<step id="300" name="HR Manager revision">

			<actions>
				<action id="301" name="approve" >
					<results>
						<default-result exit-status="HR approved" status="joining" join="10000"/>
					</results>
				</action>

				<action id="302" name="deny" >
					<results>
						<default-result exit-status="HR denied" status="joining" join="10000"/>
					</results>
				</action>
			</actions>
		</step>

	    <!-- System sends e-mail to employee =================================== -->

		<step id="400" name="Notify employee">

			<actions>
				<action id="401" name="notify"  finish="true" >
					<results>
						<default-result step="-1"/>
					</results>

				</action>

			</actions>

		</step>
	</steps>

    <!-- Splits =========================================================================== -->

    <!-- The leave approval goes to both the line manager and the HR manager ======= -->
    
	<splits>
		<split id="10000">
			<default-result status="Underway" step="200"/>
			<default-result status="Underway" step="300"/>
		</split>
	</splits>


    <!-- Joins ============================================================================ -->

    <!-- The line manager and HR manager's decisions are combined here ============= -->
	<joins>
	    
	    <!-- The 'AND/OR' join -->
	    
		<join id="10000">
			<conditions type="AND">
				<condition type="beanshell">
					<arg name="script"><![CDATA[
					    					    
					    // Behaves like an OR join if either the Manager or the
					    //  HR Director denied.
					    //
					    // Anti-Bugging: Insure the step exists.
					    
					    if( jn.get(200) != null &&
					        jn.get(200).getStatus().endsWith("denied") ) {
					        
					        typedMap.setString("result", "denied");
					        return true;
					        
					    } else if( jn.get(300) != null &&
					        jn.get(300).getStatus().endsWith("denied") ) {
					        
					        typedMap.setString("result", "denied");
					        return true;
					    }
					    
					    // Insure that both determining step have state

					    if(jn.get(200) == null || jn.get(300) == null)
					        return false;
					    
					    // Behaves like an AND join and waits for the other split
					    //  path to re-join before continuing.
					        
					    if(jn.get(200).getStatus().endsWith("approved") && 
                           jn.get(300).getStatus().endsWith("approved")) {
                                  
                            typedMap.setString("result", "approved");
                            return true;
                        }
                        
                        // Only exit this join on a single 'denied' or both 'approved'
                        
                        return false;
                        
					]]></arg>
				</condition>
			</conditions>
			
			<default-result exit-status="JoinFinished" status="${result}" step="400"/>
			
		</join>

	</joins>
	
	
</workflow>